<!-- sales.html -->
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Record Sale - KGL</title>
    <!-- Bootstrap 5 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
    />
    <style>
      :root {
        --primary-green: #2e7d32;
      }

      .product-card {
        border: 2px solid #dee2e6;
        border-radius: 10px;
        transition: all 0.3s;
        cursor: pointer;
        height: 100%;
      }

      .product-card:hover {
        border-color: var(--primary-green);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .product-card.selected {
        border-color: var(--primary-green);
        background: #f8fff8;
      }

      .stock-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.75rem;
      }

      .cart-sidebar {
        position: sticky;
        top: 20px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        height: fit-content;
        max-height: 85vh;
        overflow-y: auto;
      }

      .cart-item {
        border-bottom: 1px solid #f0f0f0;
        padding: 15px 0;
      }

      .cart-item:last-child {
        border-bottom: none;
      }

      .quantity-controls {
        width: 120px;
      }

      .quantity-btn {
        width: 35px;
        height: 35px;
        border: 1px solid #dee2e6;
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }

      .quantity-input {
        width: 50px;
        text-align: center;
        border: 1px solid #dee2e6;
        border-left: none;
        border-right: none;
        height: 35px;
      }

      .payment-method {
        border: 2px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
      }

      .payment-method:hover,
      .payment-method.selected {
        border-color: var(--primary-green);
        background: #f8fff8;
      }

      .receipt-box {
        border: 2px dashed #dee2e6;
        border-radius: 10px;
        padding: 20px;
        background: #f8f9fa;
      }

      .btn-checkout {
        background: linear-gradient(135deg, var(--primary-green), #4caf50);
        border: none;
        border-radius: 8px;
        color: white;
        padding: 15px;
        font-weight: bold;
        font-size: 16px;
        transition: all 0.3s;
      }

      .btn-checkout:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(46, 125, 50, 0.3);
      }

      .btn-checkout:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }
    </style>
  </head>
  <body>
    <!-- Sidebar (same structure) -->

    <div class="main-content">
      <div class="page-header">
        <div class="container-fluid">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h4 class="mb-1">
                <i class="bi bi-cart-check text-primary-green me-2"></i>
                Record New Sale
              </h4>
              <p class="text-muted mb-0" id="salesUserInfo">
                Attendant: Mary • Maganjo Branch
              </p>
            </div>
            <div class="d-flex align-items-center gap-3">
              <span class="badge bg-primary-green">
                <i class="bi bi-clock me-1"></i>
                <span id="currentTime">Loading...</span>
              </span>
              <a href="dashboard.html" class="btn btn-outline-primary-green">
                <i class="bi bi-arrow-left me-2"></i> Dashboard
              </a>
            </div>
          </div>
        </div>
      </div>

      <div class="container-fluid p-4">
        <!-- Customer Details -->
        <div class="card border-0 shadow-sm mb-4">
          <div class="card-body">
            <h5 class="card-title mb-4">
              <i class="bi bi-person text-primary-green me-2"></i> Customer
              Details
            </h5>
            <div class="row g-3">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label fw-semibold"
                    >Buyer Name <span class="text-danger">*</span></label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="buyerName"
                    placeholder="Enter buyer name"
                  />
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label fw-semibold">Contact Number</label>
                  <input
                    type="tel"
                    class="form-control"
                    id="buyerContact"
                    placeholder="Phone number (optional)"
                  />
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="row g-4">
          <!-- Products -->
          <div class="col-lg-8">
            <div class="card border-0 shadow-sm mb-4">
              <div class="card-body">
                <h5 class="card-title mb-4">
                  <i class="bi bi-basket text-primary-green me-2"></i> Available
                  Produce
                </h5>
                <div class="row g-3" id="productsGrid">
                  <!-- Products loaded by JavaScript -->
                </div>
              </div>
            </div>
          </div>

          <!-- Cart -->
          <div class="col-lg-4">
            <div class="cart-sidebar p-4">
              <h5 class="mb-4">
                <i class="bi bi-cart text-primary-green me-2"></i> Shopping Cart
                <span class="badge bg-primary-green ms-2" id="cartCount"
                  >0</span
                >
              </h5>

              <div id="cartItems" class="mb-4">
                <div class="text-center py-4 text-muted">
                  <i class="bi bi-cart-x fs-1 mb-3"></i>
                  <p class="mb-0">Cart is empty</p>
                  <small>Add items from the left</small>
                </div>
              </div>

              <div class="receipt-box mb-4">
                <div class="d-flex justify-content-between mb-2">
                  <span>Subtotal:</span>
                  <span id="subtotal">0 UGX</span>
                </div>
                <div class="d-flex justify-content-between mb-3">
                  <span>Tax (18%):</span>
                  <span id="tax">0 UGX</span>
                </div>
                <div class="border-top pt-3">
                  <div class="d-flex justify-content-between">
                    <span class="fw-bold">TOTAL:</span>
                    <span class="fw-bold fs-5 text-primary-green" id="total"
                      >0 UGX</span
                    >
                  </div>
                </div>
              </div>

              <div class="mb-4">
                <h6 class="fw-semibold mb-3">Payment Method</h6>
                <div class="row g-2">
                  <div class="col-6">
                    <div class="payment-method selected" data-method="cash">
                      <i class="bi bi-cash-stack fs-4 mb-2"></i>
                      <div>Cash</div>
                    </div>
                  </div>
                  <div class="col-6">
                    <div class="payment-method" data-method="mobile">
                      <i class="bi bi-phone fs-4 mb-2"></i>
                      <div>Mobile Money</div>
                    </div>
                  </div>
                </div>
              </div>

              <button class="btn btn-checkout w-100" id="checkoutBtn" disabled>
                <i class="bi bi-check-circle me-2"></i> Complete Sale
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // Sample products
      const products = [
        {
          id: 1,
          name: "Beans",
          type: "Legumes",
          stock: 8450,
          price: 2500,
          unit: "kg",
        },
        {
          id: 2,
          name: "Grain Maize",
          type: "Cereals",
          stock: 5600,
          price: 1800,
          unit: "kg",
        },
        {
          id: 3,
          name: "Cow peas",
          type: "Legumes",
          stock: 3200,
          price: 3000,
          unit: "kg",
        },
        {
          id: 4,
          name: "G-nuts",
          type: "Legumes",
          stock: 450,
          price: 3200,
          unit: "kg",
        },
        {
          id: 5,
          name: "Soybeans",
          type: "Legumes",
          stock: 2100,
          price: 2800,
          unit: "kg",
        },
      ];

      let cart = [];
      let selectedPaymentMethod = "cash";

      // Initialize
      document.addEventListener("DOMContentLoaded", function () {
        loadProducts();
        setupEventListeners();
        updateTime();



        document.getElementById("salesUserInfo").textContent =
          `User: ${username} • ${branch} Branch`;
      });

      function loadProducts() {
        const container = document.getElementById("productsGrid");
        container.innerHTML = "";

        products.forEach((product) => {
          const stockStatus = product.stock < 1000 ? "danger" : "success";
          const stockText = product.stock < 1000 ? "Low Stock" : "In Stock";

          const productHTML = `
                    <div class="col-md-6 col-lg-4">
                        <div class="product-card p-3">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h6 class="fw-semibold mb-1">${product.name}</h6>
                                    <small class="text-muted">${product.type}</small>
                                </div>
                                <span class="badge bg-${stockStatus} stock-badge">${stockText}</span>
                            </div>
                            
                            <div class="mb-3">
                                <div class="fw-bold text-primary-green fs-5">
                                    ${product.price.toLocaleString()} UGX/${product.unit}
                                </div>
                                <small class="text-muted">
                                    Stock: ${product.stock.toLocaleString()} ${product.unit}
                                </small>
                            </div>
                            
                            <div class="input-group">
                                <input type="number" class="form-control quantity-input" 
                                       value="1" min="1" max="${product.stock}"
                                       data-id="${product.id}">
                                <button class="btn btn-primary-green add-to-cart" 
                                        data-id="${product.id}"
                                        data-name="${product.name}"
                                        data-price="${product.price}"
                                        data-unit="${product.unit}">
                                    <i class="bi bi-plus-lg me-1"></i> Add
                                </button>
                            </div>
                        </div>
                    </div>
                `;

          container.innerHTML += productHTML;
        });
      }

      function setupEventListeners() {
        // Add to cart
        document.addEventListener("click", function (e) {
          if (
            e.target.classList.contains("add-to-cart") ||
            e.target.closest(".add-to-cart")
          ) {
            const btn = e.target.classList.contains("add-to-cart")
              ? e.target
              : e.target.closest(".add-to-cart");

            const productId = parseInt(btn.dataset.id);
            const productName = btn.dataset.name;
            const price = parseFloat(btn.dataset.price);
            const unit = btn.dataset.unit;
            const quantity = parseFloat(
              btn.parentElement.querySelector(".quantity-input").value,
            );

            addToCart(productId, productName, price, unit, quantity);
          }
        });

        // Payment method
        document.querySelectorAll(".payment-method").forEach((method) => {
          method.addEventListener("click", function () {
            document.querySelectorAll(".payment-method").forEach((m) => {
              m.classList.remove("selected");
            });
            this.classList.add("selected");
            selectedPaymentMethod = this.dataset.method;
          });
        });

        // Checkout
        document
          .getElementById("checkoutBtn")
          .addEventListener("click", processSale);
      }

      function addToCart(id, name, price, unit, quantity) {
        const existingIndex = cart.findIndex((item) => item.id === id);

        if (existingIndex > -1) {
          cart[existingIndex].quantity += quantity;
        } else {
          cart.push({
            id: id,
            name: name,
            price: price,
            unit: unit,
            quantity: quantity,
          });
        }

        updateCartDisplay();
      }

      function updateCartDisplay() {
        const cartContainer = document.getElementById("cartItems");
        const cartCount = document.getElementById("cartCount");
        const checkoutBtn = document.getElementById("checkoutBtn");

        if (cart.length === 0) {
          cartContainer.innerHTML = `
                    <div class="text-center py-4 text-muted">
                        <i class="bi bi-cart-x fs-1 mb-3"></i>
                        <p class="mb-0">Cart is empty</p>
                        <small>Add items from the left</small>
                    </div>
                `;
          cartCount.textContent = "0";
          checkoutBtn.disabled = true;
        } else {
          let html = "";
          let subtotal = 0;

          cart.forEach((item, index) => {
            const itemTotal = item.price * item.quantity;
            subtotal += itemTotal;

            html += `
                        <div class="cart-item">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h6 class="fw-semibold mb-1">${item.name}</h6>
                                    <small class="text-muted">
                                        ${item.price.toLocaleString()} UGX/${item.unit}
                                    </small>
                                </div>
                                <button class="btn btn-sm btn-outline-danger remove-item" 
                                        data-index="${index}">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center quantity-controls">
                                    <button class="quantity-btn decrease-qty" data-index="${index}">-</button>
                                    <input type="number" class="quantity-input" 
                                           value="${item.quantity}" min="1" 
                                           data-index="${index}">
                                    <button class="quantity-btn increase-qty" data-index="${index}">+</button>
                                </div>
                                <span class="fw-bold text-primary-green">
                                    ${itemTotal.toLocaleString()} UGX
                                </span>
                            </div>
                        </div>
                    `;
          });

          cartContainer.innerHTML = html;
          cartCount.textContent = cart.length;
          checkoutBtn.disabled = false;

          // Calculate totals
          const taxRate = 0.18;
          const tax = subtotal * taxRate;
          const total = subtotal + tax;

          document.getElementById("subtotal").textContent =
            subtotal.toLocaleString() + " UGX";
          document.getElementById("tax").textContent =
            tax.toLocaleString() + " UGX";
          document.getElementById("total").textContent =
            total.toLocaleString() + " UGX";

          // Add cart item event listeners
          addCartEventListeners();
        }
      }

      function addCartEventListeners() {
        // Remove items
        document.querySelectorAll(".remove-item").forEach((btn) => {
          btn.addEventListener("click", function () {
            const index = parseInt(this.dataset.index);
            cart.splice(index, 1);
            updateCartDisplay();
          });
        });

        // Quantity controls
        document.querySelectorAll(".quantity-input").forEach((input) => {
          input.addEventListener("change", function () {
            const index = parseInt(this.dataset.index);
            const newQuantity = parseInt(this.value);
            if (newQuantity > 0) {
              cart[index].quantity = newQuantity;
              updateCartDisplay();
            }
          });
        });

        document.querySelectorAll(".increase-qty").forEach((btn) => {
          btn.addEventListener("click", function () {
            const index = parseInt(this.dataset.index);
            cart[index].quantity += 1;
            updateCartDisplay();
          });
        });

        document.querySelectorAll(".decrease-qty").forEach((btn) => {
          btn.addEventListener("click", function () {
            const index = parseInt(this.dataset.index);
            if (cart[index].quantity > 1) {
              cart[index].quantity -= 1;
              updateCartDisplay();
            }
          });
        });
      }

      function processSale() {
        const buyerName = document.getElementById("buyerName").value.trim();

        if (!buyerName) {
          alert("Please enter buyer name");
          return;
        }

        // Prepare sale data
        const saleData = {
          items: cart,
          buyerName: buyerName,
          buyerContact: document.getElementById("buyerContact").value,
          salesAgent: localStorage.getItem("username") || "Attendant",
          paymentMethod: selectedPaymentMethod,
          branch: localStorage.getItem("userBranch"),
          date: new Date().toISOString(),
        };

        // Show confirmation
        const confirmSale = confirm(
          `CONFIRM SALE?\n\nBuyer: ${buyerName}\nItems: ${cart.length}\nTotal: ${document.getElementById("total").textContent}\nPayment: ${selectedPaymentMethod.toUpperCase()}`,
        );

        if (confirmSale) {
          // In real app, send to API
          console.log("Sale completed:", saleData);

          // Show success modal
          const successModal = new bootstrap.Modal(
            document.getElementById("successModal"),
          );
          successModal.show();

          // Reset
          cart = [];
          updateCartDisplay();
          document.getElementById("buyerName").value = "";
          document.getElementById("buyerContact").value = "";
        }
      }

      function updateTime() {
        const now = new Date();
        const timeString = now.toLocaleTimeString("en-US", {
          hour: "2-digit",
          minute: "2-digit",
          hour12: true,
        });
        document.getElementById("currentTime").textContent = timeString;

        // Update every minute
        setTimeout(updateTime, 60000);
      }
    </script>

    <!-- Success Modal -->
    <div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0">
          <div class="modal-body text-center p-5">
            <div
              class="bg-success bg-opacity-10 rounded-circle p-4 d-inline-block mb-4"
            >
              <i class="bi bi-check-circle-fill text-success fs-1"></i>
            </div>
            <h4 class="modal-title mb-3">Sale Completed Successfully!</h4>
            <p class="text-muted mb-4">
              Receipt printed. Inventory has been updated.
            </p>
            <div class="d-flex justify-content-center gap-3">
              <button
                type="button"
                class="btn btn-outline-secondary"
                data-bs-dismiss="modal"
              >
                New Sale
              </button>
              <button
                type="button"
                class="btn btn-primary-green"
                onclick="printReceipt()"
              >
                <i class="bi bi-printer me-2"></i> Print Receipt
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
